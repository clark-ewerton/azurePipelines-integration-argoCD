trigger:
  branches:
    include:
      - main

resources:
  repositories:
    - repository: manifests
      type: github
      name: clark-ewerton/argocd-example-apps
      endpoint: GitHub

variables:
- group: argocd

jobs:
- job: UpdateManifest
  displayName: "Atualizar manifest do Guestbook"
  pool:
    vmImage: 'ubuntu-latest'  # agente Linux hospedado
  steps:
    - checkout: manifests
      persistCredentials: true

    - script: |
        set -e
        echo "üîß Atualizando manifest do Guestbook com nova imagem..."
        #ls -R $(Pipeline.Workspace)/s
        cd $(Pipeline.Workspace)/s/

        # Garante que a branch master existe localmente
        git fetch origin master
        git checkout master

        echo "üîÑ Atualizando annotation para for√ßar sync: $TIMESTAMP"
        TIMESTAMP=$(date +%Y-%m-%dT%H:%M:%S)
        yq e -i ".metadata.annotations.force-sync = \"${TIMESTAMP}\"" guestbook/guestbook-ui-deployment.yaml

        # Commit
        git config --global user.name "azure-pipelines[bot]"
        git config --global user.email "azure-pipelines@dev.azure.com"
        git add guestbook/guestbook-ui-deployment.yaml
        git commit -m "Atualiza imagem do Guestbook para $NEXT_TAG"

        # Push
        git push origin master
      displayName: "Atualizar manifest com tag incremental"

- job: ArgoCDSync
  displayName: "Sync com ArgoCD via Windows"
  dependsOn: UpdateManifest
  pool:
    name: Clark  # seu agente Windows self-hosted
  steps:
    - powershell: |
            Write-Host "‚¨áÔ∏è Connecting to Ubuntu..."
            ubuntu2004
      displayName: "Connecting to Ubuntu"

    - powershell: |
            Write-Host "‚¨áÔ∏è Instalando ArgoCD CLI..."
            Invoke-WebRequest -Uri "https://github.com/argoproj/argo-cd/releases/latest/download/argocd-windows-amd64.exe" -OutFile "argocd.exe"
      displayName: "Baixar ArgoCD CLI"

    - powershell: |
        Write-Host "üîë Logando no ArgoCD..."
        .\argocd.exe login https://$(ARGOCD_SERVER) --username $(ARGOCD_USERNAME) --password $(ARGOCD_PASSWORD) --insecure --grpc-web

        Write-Host "üîÑ For√ßando refresh do app $(ARGOCD_APP)..."
        .\argocd.exe app get $(ARGOCD_APP) --refresh
        
        Write-Host "üîç Verificando status do aplicativo $(ARGOCD_APP)..."
        $appInfo = .\argocd.exe app get $(ARGOCD_APP) --grpc-web --output json | ConvertFrom-Json
        $status = $appInfo.status.sync.status

        Write-Host "Status atual: $status"

        if ($status -eq "OutOfSync") {
          Write-Host "‚ö†Ô∏è Aplica√ß√£o est√° OutOfSync. Iniciando sync..."
          .\argocd.exe app sync $(ARGOCD_APP) --grpc-web --timeout 180
          .\argocd.exe app wait $(ARGOCD_APP) --health --timeout 180
          Write-Host "‚úÖ Sync executado com sucesso!"
        }
        else {
          Write-Host "‚úÖ Aplica√ß√£o j√° est√° sincronizada. Nenhuma a√ß√£o necess√°ria."
        }
      displayName: "Sync ArgoCD apenas se estiver OutOfSync"