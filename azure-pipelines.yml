trigger:
  branches:
    include:
      - main

resources:
  repositories:
    - repository: manifests
      type: github
      name: clark-ewerton/argocd-example-apps
      endpoint: GitHub

variables:
- group: argocd

jobs:
- job: UpdateManifest
  displayName: "Update Guestbook manifest"
  pool:
    vmImage: 'ubuntu-latest'  # Hosted Linux agent
  steps:
    - checkout: manifests
      persistCredentials: true

    - script: |
        set -e
        echo "üîß Updating Guestbook manifest with a new image..."
        cd $(Pipeline.Workspace)/s/

        # Ensure the master branch exists locally
        git fetch origin master
        git checkout master

        echo "üîÑ Updating annotation to force sync: $TIMESTAMP"
        TIMESTAMP=$(date +%Y-%m-%dT%H:%M:%S)
        yq e -i ".metadata.annotations.force-sync = \"${TIMESTAMP}\"" guestbook/guestbook-ui-deployment.yaml

        # Commit changes
        git config --global user.name "azure-pipelines[bot]"
        git config --global user.email "azure-pipelines@dev.azure.com"
        git add guestbook/guestbook-ui-deployment.yaml
        git commit -m "Update Guestbook manifest with tag $NEXT_TAG"

        # Push to GitHub
        git push origin master
      displayName: "Update manifest with incremental tag"

- job: ArgoCDSync
  displayName: "Sync with ArgoCD via Windows agent"
  dependsOn: UpdateManifest
  pool:
    name: Clark  # your self-hosted Windows agent
  steps:
    - powershell: |
        Write-Host "‚¨áÔ∏è Installing ArgoCD CLI..."
        Invoke-WebRequest -Uri "https://github.com/argoproj/argo-cd/releases/latest/download/argocd-windows-amd64.exe" -OutFile "argocd.exe"
      displayName: "Download ArgoCD CLI"

    - powershell: |
        Write-Host "üîë Logging in to ArgoCD..."
        .\argocd.exe login https://$(ARGOCD_SERVER) --username $(ARGOCD_USERNAME) --password $(ARGOCD_PASSWORD) --insecure --grpc-web

        Write-Host "üîÑ Refreshing the app $(ARGOCD_APP)..."
        .\argocd.exe app get $(ARGOCD_APP) --refresh

        Write-Host "üîç Checking app status for $(ARGOCD_APP)..."
        $appInfo = .\argocd.exe app get $(ARGOCD_APP) --grpc-web --output json | ConvertFrom-Json
        $status = $appInfo.status.sync.status

        Write-Host "Current sync status: $status"

        if ($status -eq "OutOfSync") {
          Write-Host "‚ö†Ô∏è Application is OutOfSync. Starting sync..."
          .\argocd.exe app sync $(ARGOCD_APP) --grpc-web --timeout 180
          .\argocd.exe app wait $(ARGOCD_APP) --health --timeout 180
          Write-Host "‚úÖ Sync completed successfully!"
        }
        else {
          Write-Host "‚úÖ Application is already in sync. No action needed."
        }
      displayName: "Sync ArgoCD only if OutOfSync"