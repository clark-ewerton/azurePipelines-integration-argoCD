trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  ARGOCD_SERVER: 'https://unsatisfactorily-peremptory-brendon.ngrok-free.dev/'
  ARGOCD_USER: 'admin'
  ARGOCD_PASSWORD: 'SUA_SENHA_AQUI'
  ARGOCD_APP: 'guestbook'
  NEW_TAG: 'v2.0'

steps:
  # Primeiro, estamos no repo da pipeline
  - checkout: self
    displayName: "Checkout do reposit√≥rio da pipeline"

  # Agora, entramos no repo de manifests
  - checkout: git://clark-ewerton/clark-ewerton/argocd-example-apps
    displayName: "Checkout do reposit√≥rio de manifests"
    persistCredentials: true

  - script: |
      echo "üîß Atualizando manifest do Guestbook com nova imagem..."
      sed -i "s#image: ./guestbook:.#image: clark-ewerton/guestbook:${NEW_TAG}#" guestbook/guestbook-ui-deployment.yaml

      echo "üì¶ Commitando mudan√ßa no reposit√≥rio de manifests..."
      git config user.email "ci@azure.com"
      git config user.name "Azure Pipeline"
      git commit -am "Atualiza imagem do guestbook para ${NEW_TAG}"
      git push origin main
    displayName: "Atualizar manifest do Guestbook"

  # Volta para o repo original (da pipeline)
  - checkout: self
    displayName: "Retornar para o reposit√≥rio da pipeline"

  # Agora sim, continua o fluxo normal (login, sync, valida√ß√£o)
  - script: |
      echo "üîë Logando no ArgoCD..."
      argocd login $(ARGOCD_SERVER) --username $(ARGOCD_USER) --password $(ARGOCD_PASSWORD) --insecure

      echo "üîÅ Executando sync e aguardando aplica√ß√£o ficar saud√°vel..."
      argocd app sync $(ARGOCD_APP)
      argocd app wait $(ARGOCD_APP) --health --timeout 180

      echo "‚úÖ Sync conclu√≠do com sucesso!"
    displayName: "Sync com ArgoCD"