trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  ARGOCD_SERVER: 'https://SEU-ENDERECO.ngrok-free.dev'
  ARGOCD_USER: 'admin'
  ARGOCD_PASSWORD: 'SUA_SENHA_AQUI'
  ARGOCD_APP: 'guestbook'
  NEW_TAG: 'v2.0'

steps:
  - checkout: self

  # Atualiza a imagem no manifest (simula√ß√£o de nova vers√£o)
  - script: |
      echo "üîß Atualizando manifest do Guestbook com nova imagem..."
      sed -i "s#image: ./guestbook:.#image: seuusuario/guestbook:${NEW_TAG}#" manifests/guestbook-deployment.yaml

      echo "üì¶ Commitando mudan√ßa no reposit√≥rio..."
      git config user.email "ci@azure.com"
      git config user.name "Azure Pipeline"
      git commit -am "Atualiza imagem do guestbook para ${NEW_TAG}"
      git push origin main
    displayName: "Atualizar manifest do Guestbook"

  # Sincroniza com o ArgoCD e valida o hor√°rio do √∫ltimo sync
  - script: |
      echo "üîë Logando no ArgoCD..."
      argocd login $(ARGOCD_SERVER) --username $(ARGOCD_USER) --password $(ARGOCD_PASSWORD) --insecure

      echo "üïì Obtendo hor√°rio do √∫ltimo sync antes do deploy..."
      BEFORE_SYNC=$(argocd app get $(ARGOCD_APP) --output json | jq -r '.status.operationState.finishedAt')
      echo "√öltimo sync anterior: $BEFORE_SYNC"

      echo "üîÅ Executando novo sync..."
      argocd app sync $(ARGOCD_APP)

      echo "ü©∫ Aguardando aplica√ß√£o ficar saud√°vel..."
      argocd app wait $(ARGOCD_APP) --health --timeout 180

      echo "üïì Obtendo hor√°rio do √∫ltimo sync ap√≥s o deploy..."
      AFTER_SYNC=$(argocd app get $(ARGOCD_APP) --output json | jq -r '.status.operationState.finishedAt')
      echo "√öltimo sync atual: $AFTER_SYNC"

      if [ "$BEFORE_SYNC" = "$AFTER_SYNC" ] || [ -z "$AFTER_SYNC" ]; then
        echo "‚ùå O ArgoCD n√£o realizou um novo sync. Abortando."
        exit 1
      else
        echo "‚úÖ Novo sync detectado com sucesso!"
      fi
    displayName: "Sync e valida√ß√£o de hor√°rio do √∫ltimo deploy"

  # Valida se a imagem rodando √© realmente a √∫ltima deployada
  - script: |
      echo "üîç Validando imagem rodando no cluster..."
      ARGO_IMAGE=$(argocd app get $(ARGOCD_APP) --output json | jq -r '.status.summary.images[0]')
      GIT_IMAGE=$(grep "image:" manifests/guestbook-deployment.yaml | awk '{print $2}')

      echo "üß© Imagem no Git:  $GIT_IMAGE"
      echo "üöÄ Imagem no Argo: $ARGO_IMAGE"

      if [ "$ARGO_IMAGE" = "$GIT_IMAGE" ]; then
        echo "‚úÖ O ArgoCD est√° rodando a √∫ltima imagem deployada."
      else
        echo "‚ùå A imagem rodando no cluster est√° desatualizada."
        exit 1
      fi
    displayName: "Valida√ß√£o final da imagem deployada"
