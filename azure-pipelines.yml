trigger:
  branches:
    include:
      - main

resources:
  repositories:
    - repository: manifests
      type: github
      name: clark-ewerton/argocd-example-apps
      endpoint: clark-ewerton  # nome da conex√£o de service connection

pool:
  vmImage: 'ubuntu-latest'

variables:
  ARGOCD_SERVER: 'https://unsatisfactorily-peremptory-brendon.ngrok-free.dev/'
  ARGOCD_USER: 'admin'
  ARGOCD_PASSWORD: 'SUA_SENHA_AQUI'
  ARGOCD_APP: 'guestbook'
  NEW_TAG: 'v2.0'

steps:
  # Primeiro, estamos no repo da pipeline
  #- checkout: self
   # displayName: "Checkout do reposit√≥rio da pipeline"

  - checkout: manifests
  - script: |
      echo "Atualizando a imagem no manifest do guestbook..."

      cd $(Pipeline.Workspace)/s/argocd-example-apps

      # Substitui a tag da imagem (exemplo: de v5 para v6)
      sed -i 's|image: gcr.io/google-samples/gb-frontend:.*|image: gcr.io/google-samples/gb-frontend:v6|' guestbook/guestbook-ui-deployment.yaml

      git config user.email "pipeline@azuredevops.com"
      git config user.name "Azure Pipelines"

      git add guestbook/guestbook-ui-deployment.yaml
      git commit -m "Atualiza imagem do guestbook para v6"
      git push origin master
    displayName: "Atualizar manifest do Guestbook"

  # Volta para o repo original (da pipeline)
  - checkout: self
    displayName: "Retornar para o reposit√≥rio da pipeline"

  # Agora sim, continua o fluxo normal (login, sync, valida√ß√£o)
  - script: |
      echo "üîë Logando no ArgoCD..."
      argocd login $(ARGOCD_SERVER) --username $(ARGOCD_USER) --password $(ARGOCD_PASSWORD) --insecure

      echo "üîÅ Executando sync e aguardando aplica√ß√£o ficar saud√°vel..."
      argocd app sync $(ARGOCD_APP)
      argocd app wait $(ARGOCD_APP) --health --timeout 180

      echo "‚úÖ Sync conclu√≠do com sucesso!"
    displayName: "Sync com ArgoCD"