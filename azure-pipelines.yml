trigger:
  branches:
    include:
      - main

resources:
  repositories:
    - repository: manifests
      type: github
      name: clark-ewerton/argocd-example-apps
      endpoint: GitHub

variables:
  ARGOCD_SERVER: 'unsatisfactorily-peremptory-brendon.ngrok-free.dev'
  ARGOCD_USER: 'admin'
  ARGOCD_PASSWORD: 'R571Ah9iS8cj5ZMy'
  ARGOCD_APP: 'guestbook'

jobs:
- job: UpdateManifest
  displayName: "Atualizar manifest do Guestbook"
  pool:
    vmImage: 'ubuntu-latest'  # agente Linux hospedado
  steps:
    - checkout: manifests
      persistCredentials: true

    - script: |
        set -e
        echo "üîß Atualizando manifest do Guestbook com nova imagem..."
        #ls -R $(Pipeline.Workspace)/s
        cd $(Pipeline.Workspace)/s/

        echo "üîÑ Atualizando annotation para for√ßar sync: $TIMESTAMP"
        TIMESTAMP=$(date +%Y-%m-%dT%H:%M:%S)
        yq e -i ".metadata.annotations.force-sync = \"${TIMESTAMP}\"" k8s/guestbook-deployment.yaml

        # Commit
        git config --global user.name "azure-pipelines[bot]"
        git config --global user.email "azure-pipelines@dev.azure.com"
        git add guestbook/guestbook-ui-deployment.yaml
        git commit -m "Atualiza imagem do Guestbook para $NEXT_TAG"
        # Push
        git push origin master
      displayName: "Atualizar manifest com tag incremental"

- job: ArgoCDSync
  displayName: "Sync com ArgoCD via Windows"
  dependsOn: UpdateManifest
  pool:
    name: Clark  # seu agente Windows self-hosted
  steps:
    - powershell: |
            Write-Host "‚¨áÔ∏è Instalando ArgoCD CLI..."
            Invoke-WebRequest -Uri "https://github.com/argoproj/argo-cd/releases/latest/download/argocd-windows-amd64.exe" -OutFile "argocd.exe"
      displayName: "Baixar ArgoCD CLI"

    - powershell: |
            Write-Host "üîë Logando no ArgoCD..."
            .\argocd.exe login https://$(ARGOCD_SERVER) --username $(ARGOCD_USER) --password $(ARGOCD_PASSWORD) --insecure --grpc-web

            Write-Host "üîÅ Executando sync e aguardando aplica√ß√£o ficar saud√°vel..."
            .\argocd.exe app sync $(ARGOCD_APP)
            .\argocd.exe app wait $(ARGOCD_APP) --health --timeout 180

            Write-Host "‚úÖ Sync conclu√≠do com sucesso!"
      displayName: "Sync ArgoCD no Windows"