trigger:
  branches:
    include:
      - main

resources:
  repositories:
    - repository: manifests
      type: github
      name: clark-ewerton/argocd-example-apps
      endpoint: GitHub

variables:
  ARGOCD_SERVER: 'unsatisfactorily-peremptory-brendon.ngrok-free.dev'
  ARGOCD_USER: 'admin'
  ARGOCD_PASSWORD: 'R571Ah9iS8cj5ZMy'
  ARGOCD_APP: 'guestbook'

jobs:
- job: UpdateManifest
  displayName: "Atualizar manifest do Guestbook"
  pool:
    vmImage: 'ubuntu-latest'  # agente Linux hospedado
  steps:
    - checkout: manifests
      persistCredentials: true

    - script: |
        set -e
        echo "üîß Atualizando manifest do Guestbook com nova imagem..."
        #ls -R $(Pipeline.Workspace)/s
        cd $(Pipeline.Workspace)/s/

        # Garante que a branch master existe localmente
        git fetch origin master
        git checkout master

        echo "üîÑ Atualizando annotation para for√ßar sync: $TIMESTAMP"
        TIMESTAMP=$(date +%Y-%m-%dT%H:%M:%S)
        yq e -i ".metadata.annotations.force-sync = \"${TIMESTAMP}\"" guestbook/guestbook-ui-deployment.yaml

        # Commit
        git config --global user.name "azure-pipelines[bot]"
        git config --global user.email "azure-pipelines@dev.azure.com"
        git add guestbook/guestbook-ui-deployment.yaml
        git commit -m "Atualiza imagem do Guestbook para $NEXT_TAG"

        # Push
        git push origin master
      displayName: "Atualizar manifest com tag incremental"

- job: ArgoCDSync
  displayName: "Sync com ArgoCD via Windows"
  dependsOn: UpdateManifest
  pool:
    name: Clark  # seu agente Windows self-hosted
  steps:
    - powershell: |
        Write-Host "üîç Verificando estado atual da aplica√ß√£o no ArgoCD..."

        $appName = "guestbook"

        $status = & .\argocd.exe app get $appName --grpc-web --output json | ConvertFrom-Json | Select-Object -ExpandProperty status | Select-Object -ExpandProperty sync | Select-Object -ExpandProperty status

        Write-Host "üîÑ Status atual: $status"

        if ($status -eq "OutOfSync") {
            Write-Host "‚ö†Ô∏è Aplica√ß√£o est√° OutOfSync. Iniciando sync..."
            & .\argocd.exe app sync $appName --grpc-web --force
        } else {
            Write-Host "‚úÖ Aplica√ß√£o j√° est√° sincronizada. Nenhuma a√ß√£o necess√°ria."
        }
      displayName: "Sync condicional ArgoCD"