trigger:
  branches:
    include:
      - main

resources:
  repositories:
    - repository: manifests
      type: github
      name: clark-ewerton/argocd-example-apps
      endpoint: GitHub  # nome da conex√£o de service connection

pool:
  name: clark
  demands: agent.os -equals Linux

variables:
  ARGOCD_SERVER: 'https://unsatisfactorily-peremptory-brendon.ngrok-free.dev/'
  ARGOCD_USER: 'admin'
  ARGOCD_PASSWORD: 'R571Ah9iS8cj5ZMy'
  ARGOCD_APP: 'guestbook'
  NEW_TAG: 'v2.0'

steps:
  - checkout: manifests
    persistCredentials: true
  - script: |
      set -e  # Faz a pipeline falhar se algum comando der erro

      echo "üîß Atualizando manifest do Guestbook com nova imagem..."

      cd $(Pipeline.Workspace)/s/argocd-example-apps

      # Garante que a branch master existe localmente
      git fetch origin master
      git checkout master

      # Extrai a tag atual do YAML
      CURRENT_TAG=$(grep "image: gcr.io/google-samples/gb-frontend:" guestbook/guestbook-ui-deployment.yaml | sed 's/.*://')
      echo "Tag atual: $CURRENT_TAG"

      # Incrementa a tag (v1, v2, v3...)
      CURRENT_NUMBER=${CURRENT_TAG#v}         # remove o 'v' do come√ßo
      NEXT_NUMBER=$((CURRENT_NUMBER + 1))
      NEXT_TAG="v$NEXT_NUMBER"
      echo "Pr√≥xima tag: $NEXT_TAG"

      # Substitui a tag no YAML
      sed -i "s|image: gcr.io/google-samples/gb-frontend:.*|image: gcr.io/google-samples/gb-frontend:$NEXT_TAG|" guestbook/guestbook-ui-deployment.yaml

      echo "üì¶ Commitando mudan√ßa no reposit√≥rio de manifests..."

      git config --global user.name "azure-pipelines[bot]"
      git config --global user.email "azure-pipelines@dev.azure.com"

      git add guestbook/guestbook-ui-deployment.yaml
      git commit -m "Atualiza imagem do Guestbook para $NEXT_TAG"
      git push origin master

      echo "‚úÖ Manifest atualizado para $NEXT_TAG"
    displayName: "Atualizar manifest do Guestbook com tag incremental"

  # Volta para o repo original (da pipeline)
  - checkout: self
    displayName: "Retornar para o reposit√≥rio da pipeline"

  - script: |
      set -e   # Para falhar se qualquer comando der erro
      echo "‚¨áÔ∏è Instalando ArgoCD CLI..."
      curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
      chmod +x /usr/local/bin/argocd
    displayName: "Instalar ArgoCD CLI"

  # Agora sim, continua o fluxo normal (login, sync, valida√ß√£o)
  - script: |
      set -e   # Para falhar se qualquer comando der erro

      echo "üîë Logando no ArgoCD..."
      argocd login $(ARGOCD_SERVER) --username $(ARGOCD_USER) --password $(ARGOCD_PASSWORD) --insecure

      echo "üîÅ Executando sync e aguardando aplica√ß√£o ficar saud√°vel..."
      argocd app sync $(ARGOCD_APP)
      argocd app wait $(ARGOCD_APP) --health --timeout 180

      echo "‚úÖ Sync conclu√≠do com sucesso!"
    displayName: "Sync com ArgoCD"